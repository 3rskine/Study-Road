from machine import Pin, SoftI2C
import ssd1306
import dht
import time

# ------- 腳位設定 -------
DHT_PIN = 15
I2C_SDA_PIN = 21
I2C_SCL_PIN = 22

# ------- 字庫 (16x16, 每字 32 bytes) -------
font_16 = {
    '溫': bytearray([
        0x00,0x08,0x43,0xFC,0x32,0x08,0x12,0x08,0x83,0xF8,0x62,0x08,0x22,0x08,0x0B,0xF8,
        0x10,0x00,0x27,0xFC,0xE4,0xA4,0x24,0xA4,0x24,0xA4,0x24,0xA4,0x2F,0xFE,0x20,0x00
    ]),
    '度': bytearray([
        0x01,0x00,0x00,0x84,0x3F,0xFE,0x22,0x20,0x22,0x20,0x3F,0xFC,0x22,0x20,0x22,0x20,
        0x23,0xE0,0x20,0x00,0x2F,0xF8,0x24,0x10,0x22,0x60,0x41,0x80,0x86,0x60,0x38,0x0E
    ]),
    '濕': bytearray([
        0x00,0x04,0x47,0xFE,0x34,0x04,0x17,0xFC,0x84,0x04,0x67,0xFC,0x21,0x08,0x0A,0x12,
        0x17,0xBC,0x21,0x08,0xE2,0x52,0x27,0xDE,0x20,0x00,0x25,0x24,0x24,0x92,0x28,0x92
    ]),
    '環': bytearray([
        0x03,0xFC,0xFE,0x94,0x12,0x94,0x13,0xFC,0x10,0x00,0x17,0xFE,0xFC,0x00,0x13,0xF8,
        0x12,0x08,0x13,0xF8,0x10,0xA2,0x1D,0x24,0xF3,0x18,0x45,0x48,0x09,0x86,0x01,0x00
    ]),
    '境': bytearray([
        0x20,0x80,0x20,0x48,0x27,0xFC,0x21,0x10,0x20,0xA0,0xF7,0xFE,0x20,0x00,0x23,0xF8,
        0x22,0x08,0x23,0xF8,0x22,0x08,0x3B,0xF8,0xE1,0x20,0x41,0x22,0x02,0x22,0x0C,0x1E
    ]),
    # 姓名字模（你先前給的）
    '林': bytearray([
        0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x24,0xFE,0xFE,0x08,0x20,0x18,0x70,0x1C,0x70,
        0x2A,0xA8,0x2A,0xA8,0x49,0x24,0x8A,0x26,0x08,0x20,0x08,0x20,0x08,0x20,0x08,0x20
    ]),
    '柏': bytearray([
        0x10,0x00,0x10,0x20,0x10,0x40,0x10,0x84,0xFD,0xFE,0x11,0x04,0x31,0x04,0x39,0x04,
        0x55,0x04,0x51,0xFC,0x91,0x04,0x11,0x04,0x11,0x04,0x11,0x04,0x11,0xFC,0x11,0x04
    ]),
    '佑': bytearray([
        0x08,0x80,0x08,0x80,0x08,0x80,0x10,0x84,0x1F,0xFE,0x31,0x00,0x51,0x00,0x92,0x08,
        0x13,0xFC,0x15,0x08,0x19,0x08,0x11,0x08,0x11,0x08,0x11,0x08,0x11,0xF8,0x11,0x08
    ])
}

# ------- OLED 初始化 -------
print("正在初始化 OLED...")
try:
    i2c = SoftI2C(scl=Pin(I2C_SCL_PIN), sda=Pin(I2C_SDA_PIN))
    oled = ssd1306.SSD1306_I2C(128, 64, i2c)
    oled.fill(0)
    oled.text("系統啟動...", 0, 0)
    oled.show()
    time.sleep(0.8)
except Exception as e:
    print("OLED 初始化失敗:", e)

# ------- DHT11 初始化 -------
sensor = dht.DHT11(Pin(DHT_PIN))
print("DHT11 初始化完成")
time.sleep(0.2)

# ------- 檢查字模有效性 -------
def 字模有效(模):
    return isinstance(模, (bytes, bytearray)) and len(模) == 32

# ------- 繪 16x16 字函式 (橫向8點，左高位) -------
def 繪16字(字, x0, y0):
    if 字 not in font_16:
        return
    模 = font_16[字]
    if not 字模有效(模):
        return
    # 每列 2 bytes，共 16 列
    for row in range(16):
        b_left = 模[row * 2]
        b_right = 模[row * 2 + 1]
        # 左半 8 點 (左高位對應最左)
        for bit in range(8):
            if b_left & (1 << (7 - bit)):
                oled.pixel(x0 + bit, y0 + row, 1)
            else:
                oled.pixel(x0 + bit, y0 + row, 0)
        # 右半 8 點
        for bit in range(8):
            if b_right & (1 << (7 - bit)):
                oled.pixel(x0 + 8 + bit, y0 + row, 1)
            else:
                oled.pixel(x0 + 8 + bit, y0 + row, 0)

# ------- 主迴圈 -------
print("開始測量顯示...")
while True:
    try:
        sensor.measure()
        溫度 = sensor.temperature()
        濕度 = sensor.humidity()

        # 顯示在 Shell（中文）
        print("溫度:", 溫度, "°C", " 濕度:", 濕度, "%")

        # 清螢幕
        oled.fill(0)

        # 標題：環境 (16x16 ×2)
        繪16字('環', 0, 0)
        繪16字('境', 16, 0)

        # 溫度行
        繪16字('溫', 0, 16)
        繪16字('度', 16, 16)
        oled.text(str(溫度) + " C", 36, 20)

        # 濕度行
        繪16字('濕', 0, 32)
        繪16字('度', 16, 32)
        oled.text(str(濕度) + " %", 36, 36)

        # 分隔線
        oled.hline(0, 50, 128, 1)

        # 右下角顯示名字「林柏佑」
        x_name = 128 - 16 * 3  # 三字寬度
        y_name = 64 - 16
        繪16字('林', x_name, y_name)
        繪16字('柏', x_name + 16, y_name)
        繪16字('佑', x_name + 32, y_name)

        oled.show()

    except OSError as e:
        # DHT 讀取錯誤處理
        print("感測器讀取錯誤，重試中...", e)
        oled.fill(0)
        oled.text("讀取錯誤", 0, 20)
        x_name = 128 - 16 * 3
        y_name = 64 - 16
        繪16字('林', x_name, y_name)
        繪16字('柏', x_name + 16, y_name)
        繪16字('佑', x_name + 32, y_name)
        oled.show()

    time.sleep(2)
